#!/usr/bin/env bash

# Usage: subformat [key=value ...]
#
# Substitute "%key" with "value" in each line of standard input.
# "%%" represents "%".

awk -e \
   'BEGIN {
       lookup["%%"] = "%"
       maxkeylen = 2
    }
    run {
        out = ""
        while ($0 ~ /%/) {
            match($0, /[^%]*/);
            out = (out substr($0, 1, RLENGTH))
            key = "%"
            replace = "%"
            for (i = maxkeylen; i>1; --i) {
                test = substr($0, RLENGTH+1, i)
                if (test in lookup) {
                    key = test
                    replace = lookup[test]
                    break
                }
            }
            out = (out replace)
            $0 = substr($0, RLENGTH+1+length(key))
        }
        print (out $0)
    }
    /.=/ && ! run {
        match($0, /=/)
        k = ("%" substr($0, 1, RSTART-1))
        v = substr($0, RSTART+1)
        lookup[k] = v
        if (RSTART>maxkeylen) maxkeylen = RSTART
    }
    /^--$/ && ! run {
        run = 1
    }' <(for a in "${@}"; do echo "$a"; done; echo --) -

